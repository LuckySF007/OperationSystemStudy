# 데드락

## 데드락

일련의 프로세스들이 서로가 가진 자원을 기다리며 block된 상태

## 데드락 발생 조건 4가지

- Mutual exclusion(상호 배제) : 매 순간 하나의 프로세스만이 자원을 사용할 수 잇음
- No preemption(비선점) : 프로세스는 자원을 스스로 내어놓을 뿐 강제로 빼앗기지 않음
- Hold and wait(점유와 대기) : 자원을 가진 프로세스가 다른 자원을 기다릴 때 보유 자원을 놓지 않고 계속 가지고 있음
- Circular wait (환형 대기) : 자원을 기다리는 프로세스 간에 사이클이 형성되어야함

## 데드락의 처리방법

- 데드락 prevention : 자원 할당 시 데드락의 4가지 필요조건 중 어느 하나가 만족되지 않도록 하는 것
- 데드락 avoidance : 자원 요청에 대한 부가적인 정보를 이용해서 데드락의 가능성이 없는 경우에만 자원을 할당. 시스템 state가 원래 state로 돌아올 수 있는 경우에만 자원 할당
- 데드락 detection and recovery : 데드락 발생은 허용하되 그에 대한 detection 루틴을 두어 발견 시 recover
- 데드락 ignorance : 데드락을 시스템이 책임지지 않음. 유닉스를 포함한 대부분의 os가 채택

## 데드락 Prevention

데드락의 4가지 필요조건 중 어느 하나가 만족되지 않도록함

- 상호배제 → 공유해서는 안되는 자원의 경우 반드시 성립해야함
- 비선점
    - 프로세스가 어떤 자원을 기다려야하는 경우 이미 보유한 자원이 선점됨
    - 모든 필요한 자원을 얻을 수 있을 때 그 프로세스는 다시 시작됨
    - State를 쉽게 save하고 restore할 수 있는 자원에서 주로 사용 (cpu, 메모리)
- 점유와 대기
    - 프로세스가 자원을 요청할 때 다른 어떤 자원도 가지고 있지 않아야함
    - 방법 1 : 프로세스 시작 시 모든 필요한 자원을 할당받게 하는 방법 → 비효율적
    - 방법 2 : 자원이 필요할 경우 보유 자원을 모두 놓고 다시 요청
- 환형 대기 → 모든 자원 유형에 할당 순서를 정하여 정해진 순서대로만 자원 할당

=⇒ 이 방법들은 이용률을 저하시키고 처리량 감소, 기아 현상 문제가 있음

## 데드락 Avoidance

자원 요청에 대한 부가정보를 이용해서 자원 할당이 데드락으로부터 안전한지를 동적으로 조사해서 안전한 경우에만 할당

자원 할당 그래프에서 점선까지 고려. 점선은 프로세스가 어떤 자원을 미래에 요청할 수 있음을 뜻함. 점선을 포함하여 사이클이 생기지 않는 경우에만 자원을 할당해줌 → 사이클 생성 여부 조사 시 프로세스 수가 n이면 O(n^2) 시간 걸림

- 자원 당 싱글 인스턴스 : 자원 할당 그래프 알고리즘. 사이클이 있으면 데드락
- 자원 당 멀티 인스턴스 : Banker’s 알고리즘
    - 프로세스가 자원을 요구할 때, 시스템은 자원을 할당한 후에도 safe 상태로 남아있게 되는지 사전에 검사하여 교착상태 회피
    - safe 상태 : 시스템 내 프로세스들에 대한 safe 시퀀스가 존재하는 상태. 총 요청 자원의 수가 남은 자원의 수보다 적은 프로세스만 선택하여 수행
    - safe 시퀀스 : 어떤 프로세스 하나의 요청이 `가용 자원 + 모든 프로세스의 보유자원` 에 의해 충족되는 경우.  최대 자원을 줄수 있는 것을 할당한 후 나중에 해제되면, 그다음 자원 요청 또한 만족 시켜 모든 프로세스의 수행을 보장
    - safe 상태면 자원 할당, 아니면 다른 프로세스들이 자원 해지까지 대기

## 데드락 Detection, Recovery

- 탐지 : 자원 할당 그래프를 통해 교착 상태 탐지
- 회복 : 교착 상태 일으킨 프로세스를 종료시키거나 할당된 자원을 해제시켜 회복
    - 프로세스 종료 : 데드락에 연루된 프로세스들을 모두 종료 or 데드락에 연루된 프로세스들을 하나씩 종료하여 데드락이 해결되는지 확인
    - 자원 선점 : 비용을 최소화할 프로세스를 골라서 자원을 빼앗음. 그런데 동일한 프로세스가 계속 선정되는 경우 기아현상 → rollback 횟수를 같이 고려하여 해결할 수 있음

## 데드락 Ignorance

데드락이 일어나도 아무런 조치도 취하지 않음

매우 드물게 발생하므로 데드락 조치 자체가 더 큰 오버헤드일 수 있음.

대부분의 범용 os가 채택하고 있음